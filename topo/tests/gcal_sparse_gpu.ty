"""
Model equivalent to examples/gcal.ty before moving to class-based
approach. This version uses sparse representation for projections and GPU for calculations.

This script is used to test against gcal_sparse.ty_DATA. This was the
original training test data for the GCAL model (the first version of
gcal.ty_DATA) and should match nearly identically with gcal.ty_DATA.
"""

from topo.gpu.projection import CFPRF_DotProduct_Sparse_GPU, CFPLF_Hebbian_Sparse_GPU,\
                                CFPOF_DivisiveNormalizeL1_Sparse_GPU, GPUSparseCFProjection
from topo.gpu.sheet import compute_sparse_gpu_joint_norm_totals
from topo.sparse.sparsecf import SparseConnectionField
from topo.submodel.gcal import ModelGCAL
from topo.submodel import Model

@Model.definition
class SparseGPUGCAL(ModelGCAL):
    """
    Reproduces the results of the examples/gcal.ty file using sparse representation
    and runs on GPU.
    """

    @Model.GPUSettlingCFSheet
    def V1(self, properties):
        params = super(SparseGPUGCAL, self).V1(properties)
        return dict(params, joint_norm_fn=compute_sparse_gpu_joint_norm_totals)

    @Model.GPUSparseCFProjection
    def V1_afferent(self, src_properties, dest_properties):
        params = super(SparseGPUGCAL, self).V1_afferent(src_properties, dest_properties)
        return dict(params[0],
                    cf_type = SparseConnectionField,
                    response_fn = CFPRF_DotProduct_Sparse_GPU,
                    learning_fn = CFPLF_Hebbian_Sparse_GPU,
                    weights_output_fns = [CFPOF_DivisiveNormalizeL1_Sparse_GPU])


topo.sim.model = SparseGPUGCAL()